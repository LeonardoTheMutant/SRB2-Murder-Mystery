-- CHAT.LUA
-- Code by LeonardoTheMutant
--
-- Chat system

local cv_chatmode = CV_FindVar("chatmode")
local cv_chatnotifications = CV_FindVar("chatnotifications")
local cv_chatspamspeed = CV_FindVar("chatspamspeed")
local cv_chatspamburst = CV_FindVar("chatspamburst")
local cv_chatspamprotection = CV_FindVar("chatspamprotection")
local cv_mute = CV_FindVar("mute")

local function chatcolor2hudcolor(c)
	if ((not c) or (c % 0x1000) or (c > V_INVERTMAP)) then return "\x80" end
	switch(c, {
		[V_MAGENTAMAP] = do c = "^1" end,
		[V_YELLOWMAP] = do c = "^2" end,
		[V_GREENMAP] = do c = "^3" end,
		[V_BLUEMAP] = do c = "^4" end,
		[V_REDMAP] = do c = "^5" end,
		[V_GRAYMAP] = do c = "^6" end,
		[V_ORANGEMAP] = do c = "^7" end,
		[V_SKYMAP] = do c = "^8" end,
		[V_PURPLEMAP] = do c = "^9" end,
		[V_AQUAMAP] = do c = "^a" end,
		[V_PERIDOTMAP] = do c = "^b" end,
		[V_AZUREMAP] = do c = "^c" end,
		[V_BROWNMAP] = do c = "^d" end,
		[V_ROSYMAP] = do c = "^e" end,
		[V_INVERTMAP] = do c = "^f" end,
		['default'] = do c = "^0" end
	})
	return c
end

/*

local function CHAT_Say(s, m, me)
	local textcolor = chatcolor2textcolor(skincolors[s.skincolor].chatcolor)

	--Admin/Verified badges
	local badge = ""
	if (s == server) badge = "\x82~"..textcolor
	elseif (IsPlayerAdmin(s)) badge = "\x82@"..textcolor end

	for p in players.iterate do
		if (gamestate != GS_LEVEL) or (p.spectator) or (MM.IsTimelineCorrect(s.mm.timetravel.timezone, p.mm.timetravel.timezone))
			if (me)
				MAYA.ChatprintPM(p, "* "..badge..s.name.."\x80 "..m:sub(5)) --"/me" message
			else
				MAYA.ChatprintPM(p, textcolor.."<"..badge..s.name..">\x80 "..m) --Normal message
			end
			S_StartSound(nil, sfx_radio, p)
		end
	end

	if (isdedicatedserver) then MAYA.ChatprintPM(server, "<"..badge..s.name.."> "..m) end
end

local function CHAT_TeamSay(s, m) --sender, message
	for p in players.iterate do
		if (MM.IsTimelineCorrect(s.mm.timetravel.timezone, p.mm.timetravel.timezone))
			if ((p.mm.role == s.mm.role) and (s.mm.role == ROLE_MURDERER))
				MAYA.ChatprintPM(p, "\x85[TEAM]<"..s.name.."> "..m)
				S_StartSound(nil, sfx_radio, p)
			elseif (p.mm.role == ROLE_SHERIFF) or (p.mm.role == ROLE_HERO)
				if (s.mm.role == ROLE_SHERIFF)
					MAYA.ChatprintPM(p, "\x84[TEAM]<"..s.name.."> "..m)
				elseif (s.mm.role == ROLE_HERO)
					MAYA.ChatprintPM(p, "\x84[TEAM]\x82<"..s.name..">\x84 "..m)
				end
				S_StartSound(nil, sfx_radio, p)
			end
		end
	end
end
*/

--SAYDEAD command - Say to the Dead Chat (as Server or Administrator)
COM_AddCommand("SAYDEAD", function(p, ...) --sender, message
	if (gametype != GT_LTMMURDERMYSTERY)
		CONS_Printf(p, "The game must be LTM's Murder Mystery to access this command")
		return
	end
	
	--get the message string
	local arg = {...}
	local m = ""
	for i = 1, #arg do
		m = $ + arg[i]
		if (i < #arg) then m = $ + " " end --add space between words (arguments)
	end
	
	local sender
	if (p == server) then sender = "\x80~SERVER\x86"
	else sender = p.name end
	
	if (#m)
		--send the message
		for p in players.iterate do
			if (p.spectator) MAYA.ChatprintPM(p, "\x86{"..sender.."} "..m) end
		end
		if (isdedicatedserver) then CONS_Printf(server, "{"..sender.."} "..m) end
	else
		CONS_Printf(p, "\x87SAYDEAD [message]\x80 - Send message to the Dead Chat.")
	end
end, COM_ADMIN)

/*
addHook("PlayerMsg", function(s, type, t, m) --source, type, target, msg
	if (gametype != GT_LTMMURDERMYSTERY) or (not s.mm) or (not sMM.lang) then return end

	if (s.spectator)
		switch(type, {
			[0] = do --If dead player sends a message, make that messsage appear only to the dead players
				for p in players.iterate do if (p.spectator) MAYA.ChatprintPM(p, "\x86{"..s.name.."} "..m) end end
				if (isdedicatedserver) CONS_Printf(server, "{"..s.name.."} "..m) end
			end,
			[2] = do --PM messages in different design for DEAD
				if (t.spectator)
					MAYA.ChatprintPM(s, "\x82[TO]\x86{"..t.name.."} "..m)
					MAYA.ChatprintPM(t, "\x82[PM]\x86{"..s.name.."} "..m)
				else CONS_Printf(s, t.name.." ".."is alive, message not sent") end
			end
		})
	else
		switch(type, {
			[0] = do
				if (m:sub(1,1) == "%") and (gamestate == GS_LEVEL)
					CHAT_TeamSay(s, m:sub(2))  --SAYTEAM shortcut
				else
					CHAT_Say(s, m, m:find("/me ", 1,4, true)) --send message normally (handle "/me" messages too)
				end
			end,
			[1] = do  --SAYTEAM
				if (gamestate == GS_LEVEL) then CHAT_TeamSay(s, m)
				else CHAT_Say(s, m) end
			end,
			[2] = do --SAYTO or "/pm"
				return false
			end
		})
	end
	return true
end)
*/

--
-- UTF-8 CHAT
--

local HU_MAXMSGLEN = 223

local ctrldown = false
local leftctrldown = false
local rightctrldown = false

local shiftdown = false
local leftshiftdown = false
local rightshiftdown = false

local altdown = false
local leftaltdown = false
local rightaltdown = false

local deadkey = false

--
-- Get the modifier key state
--
addHook("KeyDown", function(key)
	switch(key.num, {
		[KEY_LCTRL] = do
			leftctrldown = true
		end,
		[KEY_RCTRL] = do
			rightctrldown = true
		end,
		[KEY_LSHIFT] = do
			leftshiftdown = true
		end,
		[KEY_RSHIFT] = do
			rightshiftdown = true
		end,
		[KEY_LALT] = do
			leftaltdown = true
		end,
		[KEY_RALT] = do
			rightaltdown = true
		end,
	})
end)
addHook("KeyUp", function(key)
	switch(key.num, {
		[KEY_LCTRL] = do
			leftctrldown = false
		end,
		[KEY_RCTRL] = do
			rightctrldown = false
		end,
		[KEY_LSHIFT] = do
			leftshiftdown = false
		end,
		[KEY_RSHIFT] = do
			rightshiftdown = false
		end,
		[KEY_LALT] = do
			leftaltdown = false
		end,
		[KEY_RALT] = do
			rightaltdown = false
		end,
	})
end)

local function GetNextLayout()
	local langkeys = {}
	for langEntry in pairs(MM.text) do table.insert(langkeys, langEntry) end
	table.sort(langkeys)

	for id, lang in ipairs(langkeys) do
		if (lang == MM.keyboardLayout) then
			if (id + 1 > #langkeys) then return langkeys[1]
			else return langkeys[id + 1] end
		end
	end
end

local function GetPrevLayout()
	local langkeys = {}
	for langEntry in pairs(MM.text) do table.insert(langkeys, langEntry) end
	table.sort(langkeys)

	for id, lang in ipairs(langkeys) do
		if (lang == MM.keyboardLayout) then
			if (id - 1 < 1) then return langkeys[#langkeys]
			else return langkeys[id - 1] end
		end
	end
end

addHook("PlayerMsg", function(s, typ, t, msg)
	if (gametype ~= GT_LTMMURDERMYSTERY) or (typ == 3) then return end

	if (cv_mute.value or s.muted and s ~= server and not IsPlayerAdmin(s))
		printf("\x87Murder Mystery\x80: \x82WARNING:\x80 Illegal say command received from %s while muted!", s.name)
		MM.PunishPlayer(s, "Usage of chat hacks")
		return true
	end

	local target
	local origmsg = msg
	if (msg:sub(1,2) == "$&") --Recieved a message from MAYA
		if ((#msg % 2) == 1) then
			MM.DebugPrint("Recieved an odd amount of bytes! (Message: \""..msg.."\")")
			return true
		end
		target = tonumber(msg:sub(3,4)) or 0
		msg = MAYA.Decode($:sub(5))
	else --Something else uses vanilla protocol
		if (typ == 1) target = -1 --SayTeam
		else 
			if (t) then target = #t + 1 --SayTo
			else target = 0 end --Say
		end
	end

	local spam_eatmsg = 0

	if (MAYA.spam_tokens[#s] <= 0 and cv_chatspamprotection.value)
		MM.DebugPrint("Received SAY cmd too quickly from Player "..(#s + 1).." ("..s.name.."), assuming as spam and blocking message.");
		MAYA.spam_tics[#s] = 0
		spam_eatmsg = 1
	else
		MAYA.spam_tokens[#s] = $ - 1
	end

	if (spam_eatmsg) then return true end

	local action
	--Handle "/me" actions, but only in messages to everyone
	if (target == 0) and (#msg > 4) and (string.sub(msg, 1, 4) == "/me ")
		msg = $:sub(5)
		action = true
	end

	local dispname = s.name

	local pn --player number
	if (isdedicatedserver) then pn = 0 --#consoleplayer fails for dedicated hosts, we have to make the server's player number ourself
	else pn = #consoleplayer end

	if (s == consoleplayer) or (target == -1 and MM.AreTeammates(consoleplayer, s)) or (target == 0) or (pn == target - 1)
		local prefix = ""
		local cstart = ""
		local cend = ""
		local adminchar = "^2~^3"
		local remotechar = "^2@^3"
		local fmt2
		local textcolor = "^0"
		local tempchar

		--Is player dead?
		if (s.spectator)
			cstart = "^6"
			textcolor = "^6"
		elseif (target == -1) --say team
			cstart = MM.RoleColorHUD[s.mm.role]
			textcolor = cstart
		else
			cstart = chatcolor2hudcolor(skincolors[s.skincolor or 1].chatcolor)
		end
		prefix = cstart

		--Give admins and remote admins their symbols
		if (s == server) or (IsPlayerAdmin(s)) then tempchar = "" end
		if (tempchar)
			if (s == server)
				tempchar = $..adminchar
			elseif (IsPlayerAdmin(s))
				tempchar = $..remotechar
			end
			tempchar = $..cstart
			cstart = tempchar
		end

		if (action)
			fmt2 = "* %s%s%s%s ^2%s%s"
		elseif (target - 1 == pn) --To you
			prefix = "^2[PM]"
			cstart = "^2"
			textcolor = "^2"
			fmt2 = "%s<%s%s>%s^0 %s%s"
		elseif (target > 0) --By you, to another player
			dispname = players[target - 1].name or "MissingNo."
			prefix = "^2[TO]"
			cstart = "^2"
			fmt2 = "%s<%s%s>%s^0 %s%s"
		elseif (target == 0) --To everyone
			if (s.spectator) fmt2 = "%s{%s%s%s}^6 %s%s"
			else fmt2 = "%s<%s%s%s>^0 %s%s" end
		else --To your team
			prefix = (MM.RoleColorHUD[s.mm.role] or "^3").."[TEAM]"
			fmt2 = "%s<%s%s>^0%s %s%s"
		end
		if (isdedicatedserver)
			MAYA.Chatprint(string.format(fmt2, prefix, cstart, dispname, cend, textcolor, origmsg))
		else
			if (not s.spectator or (s.spectator and consoleplayer.spectator))
				MAYA.Chatprint(string.format(fmt2, prefix, cstart, dispname, cend, textcolor, msg), cv_chatnotifications.value)
			end
		end
	end
	return true
end)

local last_valid = {}
local last_name = {}

local function CHAT_Ticker()
	for i = 0, 31 do
		if (MAYA.spam_tokens[i] < cv_chatspamburst.value)
			MAYA.spam_tics[i] = $ + 1
			if (MAYA.spam_tics[i] > cv_chatspamspeed.value)
				MAYA.spam_tokens[i] = $ + 1
				MAYA.spam_tics[i] = 0
			end
		end

		--
		-- TIC CATCHER
		-- Catching important system events which are usually not triggerable via standart Hooks
		--
		if (not isdedicatedserver)
			local p = players[i]
			if valid(p)
				--Player joined
				if (not last_valid[i])
					MAYA.SystemChatprint(string.format("^2*%s has joined the game (player %d)", p.name, i))
					last_valid[i] = true
					last_name[i] = p.name
				end

				--Player renamed
				if (last_name[i] and last_name[i] ~= p.name)
					if (gamestate == GS_LEVEL and p.spectator) then MM.PunishPlayer(p, "Do not rename when dead!")
					else
						MAYA.SystemChatprint(string.format("^2*%s renamed", last_name[i]))
						last_name[i] = p.name
					end
				end
			else
				--Player left
				if (last_valid[i])
					MAYA.SystemChatprint(string.format("^2*%s left the game", last_name[i] or "Player"))
					last_valid[i] = false
					last_name[i] = nil
				end
			end
		end
	end

	if (not isdedicatedserver)
		for i = 0, MAYA.chat_nummsg_min - 1 do
			if (MAYA.chat_timers[i] > 0) then MAYA.chat_timers[i] = $ - 1
			else MAYA.RemoveChatText_Mini() end
		end

		if (gametype ~= GT_LTMMURDERMYSTERY) then return end
		MAYA.tick = $ + 1
		MAYA.tick = $ & 7

		if (MM.hud.chat.active)
			--Count down the scroll timer
			if (MAYA.chat_scrolltime > 0) then MAYA.chat_scrolltime = $ - 1 end
		end
	end
end

addHook("ThinkFrame", CHAT_Ticker)
addHook("IntermissionThinker", CHAT_Ticker)

local PUNCTUATION = [[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]]

local function M_JumpWordReverse(line, offset)
	if offset == 0 then
		return 0
	end
	offset = offset - 1
	local c = string.sub(line, offset + 1, offset + 1)
	local is
	if c:match("%s") then
		is = function(ch) return ch:match("%s") end
	elseif c:match("[%p]") then
		is = function(ch) return ch:match("[%p]") end
	else
		is = function(ch) return ch:match("[%w]") end
	end
	local function test(idx)
		local ch = string.sub(line, idx, idx)
		return is(ch)
	end
	while offset > 0 and test(offset) do
		offset = offset - 1
	end
	return offset
end

local function M_JumpWord(line)
	local c = string.sub(line, 1, 1)
	if c:match("%s") then
		-- Return length of leading whitespace
		local _, e = line:find("^%s+")
		return e and e or 0
	elseif c:match("[%p]") then
		-- Return length of leading punctuation
		local _, e = line:find("^["..PUNCTUATION:gsub("%p", "%%%0").."]+")
		return e and e or 0
	else
		local c2 = string.sub(line, 2, 2)
		if c2:match("%s") then
			-- 1 + length of whitespace after first char
			local _, e = line:sub(2):find("^%s+")
			return 1 + (e and e or 0)
		else
			-- Return length up to first whitespace or punctuation
			local _, e = line:find("^[^%s"..PUNCTUATION:gsub("%p", "%%%0").."]+")
			return e and e or 0
		end
	end
end

addHook("KeyDown", function(key)
	if (gametype != GT_LTMMURDERMYSTERY) then return false end

	--print(key.num)
	shiftdown = leftshiftdown or rightshiftdown
	ctrldown = leftctrldown or rightctrldown
	altdown = leftaltdown or rightaltdown

	local c = key.num

	local w_chat_table = {}
	for i, c, b in unicode.chars(MAYA.w_chat) do w_chat_table[i] = c end

	if (MM.hud.chat.active)
		if (((c > 31) and (c < 127)) or ((c > 198) and (c < 210)) or (c == 228)) and not (ctrldown and c == KEY_SPACE)
			if ((MAYA.CHAT_MUTE or unicode.len(MAYA.w_chat) >= HU_MAXMSGLEN)) then return true end

			local chr

			if (c == 32)
				chr = " "
			else
				local modifiers = 1 + bool2int(shiftdown) + bool2int(altdown)*2 --0x1 -Shift, 0x2 - Alt (+1 for LUA's non-0-indexing)
				print(modifiers)
				
				if (MM.text[MM.keyboardLayout]["KEYBOARD"] and MM.text[MM.keyboardLayout]["KEYBOARD"][modifiers] and MM.text[MM.keyboardLayout]["KEYBOARD"][modifiers][c])
					chr = MM.text[MM.keyboardLayout]["KEYBOARD"][modifiers][c]
				elseif (MAYA.defaultLayout[modifiers] and MAYA.defaultLayout[modifiers][c])
					chr = MAYA.defaultLayout[modifiers][c]
				end

				--Register the dead key press
				if ((type(chr) == "table") and (not deadkey))
					deadkey = chr[1]
					return true
				end
			end

			if (chr and type(chr) == "table") then chr = chr[1] end

			if (deadkey) --Was dead key previously pressed?
				if (MM.text[MM.keyboardLayout]["KEYBOARD"] and MM.text[MM.keyboardLayout]["KEYBOARD"][deadkey..chr])
					--Dead key + Valid combination key
					table.insert(w_chat_table, MAYA.c_input, MM.text[MM.keyboardLayout]["KEYBOARD"][deadkey..chr])
					MAYA.c_input = $ + 1
				else
					--Dead key + Invalid combination key, add two sepparate characters
					table.insert(w_chat_table, MAYA.c_input, deadkey)
					MAYA.c_input = $ + 1
					table.insert(w_chat_table, MAYA.c_input, chr)
					MAYA.c_input = $ + 1
				end
				deadkey = nil
			else --Regular key
				if (chr)
					table.insert(w_chat_table, MAYA.c_input, chr) --Insert the character
					MAYA.c_input = $ + 1
				end
			end

			--"Compile" the string from table
			MAYA.w_chat = table.concat(w_chat_table)
		end


		--Switch the keyboard layout
		--Left CTRL+SPACE, next layout
		if (leftctrldown and c == KEY_SPACE)
			MM.keyboardLayout = GetNextLayout()
			return true
		end
		--Right CTRL+SPACE, previous lauout
		if (rightctrldown and c == KEY_SPACE)
			MM.keyboardLayout = GetPrevLayout()
			return true
		end

		--Ignore modifier keys
		--Note that we do this here so users can still set
		--their chat keys to one of these, if they so desire.
		if (c == KEY_LSHIFT) or (c == KEY_RSHIFT) or
			(c == KEY_LCTRL) or (c == KEY_RCTRL) or
			(c == KEY_LALT) or (c == KEY_RALT)
			return true
		end

		if (c == KEY_ENTER)
			if (not MAYA.CHAT_MUTE)
				MAYA.SendChatMessage();
			end

			MM.hud.chat.active = false
			MAYA.c_input = 1
			MAYA.chat_scrollmedown = true -- you hit enter, so you might wanna autoscroll to see what you just sent. :)
			input.setMouseGrab(true)
		elseif (c == KEY_ESCAPE or ((c == input.gameControlToKeyNum(GC_TALKKEY) or c == input.gameControlToKeyNum(GC_TEAMKEY)) and c >= KEY_MOUSE1))
			input.setMouseGrab(true)
			MM.hud.chat.active = false
			MAYA.c_input = 1
		elseif ((c == KEY_UPARROW or c == KEY_MOUSEWHEELUP) and MAYA.chat_scroll > 0)
			MAYA.chat_scroll = $ - 1
			MAYA.justscrolledup = true
			MAYA.chat_scrolltime = 4
		elseif ((c == KEY_DOWNARROW or c == KEY_MOUSEWHEELDOWN) and MAYA.chat_scroll < MAYA.chat_maxscroll and MAYA.chat_maxscroll > 0)
			MAYA.chat_scroll = $ + 1
			MAYA.justscrolleddown = true
			MAYA.chat_scrolltime = 4
		elseif (c == KEY_LEFTARROW and MAYA.c_input != 1)
			if (ctrldown) MAYA.c_input = M_JumpWordReverse(MAYA.w_chat, MAYA.c_input)
			else MAYA.c_input = $ - 1 end
		elseif (c == KEY_RIGHTARROW and MAYA.c_input <= unicode.len(MAYA.w_chat))
			if (ctrldown) MAYA.c_input = $ + M_JumpWord(w_chat_table[MAYA.c_input + 1])
			else MAYA.c_input = $ + 1 end
		elseif (c == KEY_BACKSPACE)
			if (MAYA.CHAT_MUTE or MAYA.c_input <= 1) return true end

			table.remove(w_chat_table, MAYA.c_input - 1)
			MAYA.c_input = $ - 1
			MAYA.w_chat = table.concat(w_chat_table)
		elseif (c == KEY_DEL)
			if (MAYA.CHAT_MUTE or MAYA.c_input > unicode.len(MAYA.w_chat)) return true end

			table.remove(w_chat_table, MAYA.c_input)
			MAYA.w_chat = table.concat(w_chat_table)
		elseif (c == KEY_HOME)
			MAYA.c_input = 1
		elseif (c == KEY_END)
			MAYA.c_input = unicode.len(MAYA.w_chat) + 1
		end

		return true
	else
		if (c == input.gameControlToKeyNum(GC_TALKKEY) and not MAYA.OLD_MUTE)
			input.setMouseGrab(false)
			MM.hud.chat.active = true
			MAYA.w_chat = ""
			MAYA.teamtalk = false
			MAYA.chat_scrollmedown = true
			MAYA.typelines = 1
			return true
		end
		if (c == input.gameControlToKeyNum(GC_TEAMKEY) and not MAYA.OLD_MUTE)
			input.setMouseGrab(false)
			MM.hud.chat.active = true
			MAYA.w_chat = ""
			MAYA.teamtalk = true
			MAYA.chat_scrollmedown = true
			MAYA.typelines = 1
			return true
		end
	end

	return false
end)

hud.add(function(v)
	if (gametype != GT_LTMMURDERMYSTERY) then return end

	MAYA.CHAT_MUTE = (cv_mute.value or players[#consoleplayer].muted) and not (consoleplayer == server or IsPlayerAdmin(consoleplayer))
	MAYA.OLD_MUTE = (MAYA.OLDCHAT and (cv_mute.value or players[#consoleplayer].muted) and not (consoleplayer == server or IsPlayerAdmin(consoleplayer)))

	if (MM.hud.chat.active)
		MAYA.DrawChat(v)

		if (MM.debug)
			if (leftshiftdown) v.drawString(0, 176, "S") end
			if (leftctrldown) v.drawString(0, 184, "C") end
			if (leftaltdown) v.drawString(0, 192, "A") end
			if (rightshiftdown) v.drawString(8, 176, "S") end
			if (rightctrldown) v.drawString(8, 184, "C") end
			if (rightaltdown) v.drawString(8, 192, "A") end
		end
	else
		MAYA.typelines = 1
		MAYA.chat_scrolltime = 0

		if (cv_chatmode.value < 2) then MAYA.DrawMiniChat(v) end
	end

end, "game")

hud.add(function(v)
	if (gametype != GT_LTMMURDERMYSTERY) then return end

	MAYA.CHAT_MUTE = (cv_mute.value or players[#consoleplayer].muted) and not (consoleplayer == server or IsPlayerAdmin(consoleplayer))
	MAYA.OLD_MUTE = (MAYA.OLDCHAT and (cv_mute.value or players[#consoleplayer].muted) and not (consoleplayer == server or IsPlayerAdmin(consoleplayer)))

	if (MM.hud.chat.active)
		MAYA.DrawChat(v)

		if (MM.debug)
			if (leftshiftdown) v.drawString(0, 176, "S") end
			if (leftctrldown) v.drawString(0, 184, "C") end
			if (leftaltdown) v.drawString(0, 192, "A") end
			if (rightshiftdown) v.drawString(8, 176, "S") end
			if (rightctrldown) v.drawString(8, 184, "C") end
			if (rightaltdown) v.drawString(8, 192, "A") end
		end
	else
		MAYA.typelines = 1
		MAYA.chat_scrolltime = 0

		if (cv_chatmode.value < 2) then MAYA.DrawMiniChat(v) end
	end
end, "intermission")
