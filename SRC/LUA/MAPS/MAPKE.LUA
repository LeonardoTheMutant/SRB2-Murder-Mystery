--Shadow Moses Island (MAPKE)
--Level script
--Original level design by Konami & Hideo Kojima
--SRB2 map port & code by LeonardoTheMutant

local timerConst = {
	105, --3 seconds, elevator came to the floor and waits to open doors
	700 --20 seconds, evevator travel time
}

local elevatorState = {
	0, --floor (0 - Top, 1 - B1, 2 - B2)
	0, --doors state (0 - closed, 1 - open)
	0, --timer
	0, --direction (0 - none/idle, 1 - up, 2 - down, 3 - just arrived)
}

local function P_OpenElevatorDoors()
	if (not elevatorState[2]) then
		P_LinedefExecute(94)
		elevatorState[2] = 1
	end
end

local function P_CloseElevatorDoors()
	if (elevatorState[2]) then
		P_LinedefExecute(95)
		elevatorState[2] = 0
	end
end

local function P_ElevatorMove()
	local mo
	switch(elevatorState[1], {
		[0] = do --from Top Floor
			local mo = P_SpawnMobj(-192*FU, 2752*FU, 0, MT_RAY)
			searchBlockmap("objects", function(refmobj, foundmobj)
				P_MoveOrigin(foundmobj, foundmobj.x - 2048*FU, foundmobj.y, foundmobj.z)
			end, mo, (mo.x - 8388608), (mo.x + 8388608), (mo.y - 8388608), (mo.y + 8388608))
		end,
		[1] = do --from Basement 1
			local mo = P_SpawnMobj(-192*FU, 2752*FU, 0, MT_RAY)
			searchBlockmap("objects", function(refmobj, foundmobj)
				P_MoveOrigin(foundmobj, foundmobj.x - 2048*FU, foundmobj.y, foundmobj.z) --dummy values
			end, mo, (mo.x - 8388608), (mo.x + 8388608), (mo.y - 8388608), (mo.y + 8388608))
		end,
		[2] = do --from Basement 2
			local mo = P_SpawnMobj(-192*FU, 2752*FU, 0, MT_RAY)
			searchBlockmap("objects", function(refmobj, foundmobj)
				P_MoveOrigin(foundmobj, foundmobj.x - 2048*FU, foundmobj.y, foundmobj.z) --dummy values
			end, mo, (mo.x - 8388608), (mo.x + 8388608), (mo.y - 8388608), (mo.y + 8388608))
		end,
	})
	P_StartQuake(FRACUNIT, timerConst[2] - 70, {-2240*FRACUNIT, 2752*FRACUNIT, 0}, 160*FRACUNIT)
end

local function P_ElevatorFloor()
	local mo = P_SpawnMobj(-2240*FU, 2752*FU, 0, MT_RAY)
	searchBlockmap("objects", function(refmobj, foundmobj)
		switch(elevatorState[1], {
			[0] = do --to Top floor
				P_MoveOrigin(foundmobj, foundmobj.x + 2048*FU, foundmobj.y, foundmobj.z)
			end,
			[1] = do --to Basement 1
				P_MoveOrigin(foundmobj, foundmobj.x + 2048*FU, foundmobj.y, foundmobj.z) --dummy values
			end,
			[2] = do --to Basement 2
				P_MoveOrigin(foundmobj, foundmobj.x + 2048*FU, foundmobj.y, foundmobj.z) --dummy values
			end,
		})
		S_StartSound(nil, sfx_ding, foundmobj.player)
	end, mo, (mo.x - 8388608), (mo.x + 8388608), (mo.y - 8388608), (mo.y + 8388608))
end

addHook("ThinkFrame", do
	if (elevatorState[3]) then elevatorState[3] = $ - 1 end
	if (not elevatorState[3]) --if timer ran out
		if (elevatorState[2]) then --if the doors are open
			if (not elevatorState[4]) then P_CloseElevatorDoors() --if elevator does not plan to move close the elevator doors
			elseif (elevatorState[4] == 3) then elevatorState[4] = 0 end --if elevator has just arrived change its direction to none/idle
		else --doors are closed
			if (elevatorState[4]) --if evetator plans to move
				if (elevatorState[4] == 1) then --going up
					elevatorState[1] = $ + 1
				elseif (elevatorState[4] == 2) then --going down
					elevatorState[1] = $ - 1
				end
				P_ElevatorFloor()
				elevatorState[3] = timerConst[1]
				elevatorState[4] = 3
				P_OpenElevatorDoors(elevatorState[1])
			end
		end
	else --timer is not 0
		--Move players into the elevator and do the evelator thingies
		if (((elevatorState[4] == 1) or (elevatorState[4] == 2)) and (elevatorState[3] == timerConst[2] - 35))
			P_ElevatorMove()
		end
	end
end)

addHook("LinedefExecute", do
	if (not elevatorState[4]) then
		P_OpenElevatorDoors()
		elevatorState[3] = 5*TICRATE
	end
end,"KEELVOPN")

addHook("LinedefExecute", do
	if (not elevatorState[4]) then
		P_CloseElevatorDoors()
		elevatorState[3] = timerConst[2]
		elevatorState[4] = 1
	end
end,"KEELVUP")

addHook("LinedefExecute", do
	if (not elevatorState[4]) then
		P_CloseElevatorDoors()
		elevatorState[3] = timerConst[2]
		elevatorState[4] = 2
	end
end,"KEELVDWN")

local duelSign = {
	palette = {
		{31, 39, 41, 31},
		{31, 39, 41, 47},
		{31, 39, 41, 46},
		{31, 39, 41, 45},
		{31, 39, 41, 44},
		{31, 39, 41, 43},
		{31, 39, 41, 42},
		{31, 39, 41, 41},
		{31, 39, 41, 40},
		{31, 39, 41, 39}
	},
	image = {
		"0000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"0000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333111111111133331111333333333311111111111113311111111113333111111111111333300",
		"0033331111111111113331111333333333311111111111113311111111111333111111111111333300",
		"0033331111333331111331111333333333311113333333333311113333311133333311113333333300",
		"0033331111333333111331111333333333311113333333333311113333331133333311113333333300",
		"0033331111333331111331111333333333311111111111333311113333311133333311113333333300",
		"0033331111111111111331111333333333311111111111333311111111111333333311113333333300",
		"0033331111111111111331111333333333311113333333333311111111111333333311113333333300",
		"0033331111333331111331111333333333311113333333333311113333111133333311113333333300",
		"0033331111333333111331111333333333311113333333333311113333311133333311113333333300",
		"0033331111333333111331111111111113311111111111113311113333311133333311113333333300",
		"0033331111333333111331111111111113311111111111113311113333311133333311113333333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333111111133113311111111113311331111111331133111111111111331133111111113333300",
		"0033333111111133113311111111113311331111111331133111111111111331133111111113333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0033333333333333333333333333333333333333333333333333333333333333333333333333333300",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111111111000000000000000111111111111000000000011111000000011111111111111100",
		"0011111111111111000000000000000111111111111000000000011100001110000111111111111100",
		"0011111111111000000011111000000111111111111000110000011100001110000111111111111100",
		"0011111111111000000011111000000111111111111000110000011100001110000111111111111100",
		"0011111111111111111111000000000111111111111000110001110000111111100001111111111100",
		"0011111111111111111111000011111111111111111000000001100000111111100000111111111100",
		"0011111111111111111111000011111111111111111000000001100000111111100000111111111100",
		"0011111111111000000000000000000000000011111000001111111100000000000111111111111100",
		"0011111111111000000000000000000000000011111000001111111100000000000111111111111100",
		"0011111111111000000000000000000000000011111000001111111111100000111111111111111100",
		"0011111111111000001111111111111111111111111000000000011111100000111111111111111100",
		"0011111111111000001111111111111111111111111000111000011111100000111111111111111100",
		"0011111111111000001100000000000001111111111000111000000000000000000000111111111100",
		"0011111111111000001100001111100001111111111000111000000001100000110000111111111100",
		"0011111111111000001100001111100001111111111000111000000001100000110000111111111100",
		"0011111111111000001100001111100001111111111000111000000001100000110000111111111100",
		"0011111111111000001100001100000001111111111000111000000000000000000000111111111100",
		"0011111111111000001100001100000001111111111000111000011111110001111111111111111100",
		"0011111111111000001100001111111111111111111000111000011111110001111111111111111100",
		"0011111111111000001100001111111111111111111000111000011111110001111111111111111100",
		"0011111111111000001100001111111111111111111000111000011111110001111111111111111100",
		"0011111111111000001100001111111111111111111000111000011111110001111111111111111100",
		"0011111111111000001100001111111111111111111000100000111111000000011111111111111100",
		"0011111111111000001100001111111111111111111000100001111111000000011111111111111100",
		"0011111111111000001100001111111110000111111000111111111100001110000111111111111100",
		"0011111111110000011111000000000000000011111000111111111100001110000111111111111100",
		"0011111111000000111111100000000000000011111000111111100000111111100000111111111100",
		"0011111111000000111111100000000000000111111111111111100000111111100000111111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111000000000000000000000000000000000000000000000000000000000000001111111100",
		"0011111111000000000000000000000000000000000000000000000000000000000000001111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111100000000001111000000000011111111111100000000001111000000000011111111100",
		"0011111111010000000010110100000000101111111111010000000010110100000000101111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111001111111100110011111111001111111111001111111100110011111111001111111100",
		"0011111111010000000010110100000000101111111111010000000010110100000000101111111100",
		"0011111111100000000001111000000000011111111111100000000001111000000000011111111100",
		"0011111111211111111110112111111111101111111111211111111110112111111111101111111100",
		"0011111111221111111100112211111111001111111111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001111111111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001111111111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001111111111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001111111111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001110000111221111111100112211111111001111111100",
		"0011111111221111111100112211111111001110000111221111111100112211111111001111111100",
		"0011111111210000000010112100000000101110000111210000000010112100000000101111111100",
		"0011111111100000000001111000000000011110000111100000000001111000000000011111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0011111111000000000000000000000000000000000000000000000000000000000000001111111100",
		"0011111111000000000000000000000000000000000000000000000000000000000000001111111100",
		"0011111111111111111111111111111111111111111111111111111111111111111111111111111100",
		"0000000000000000000000000000000000000000000000000000000000000000000000000000000000",
		"0000000000000000000000000000000000000000000000000000000000000000000000000000000000"
	}
}

local function sortOfSine(a, base)
	local b = a % (base * 2)
	if (b > (base - 1)) then return (base * 2) - b - 1
	else return b end
end

hud.add(function(v)
	if (gamemap != 474) then return end
	v.drawString(200, 184, "\x85".."Elevator state", V_SNAPTOLEFT, "thin")
	v.drawString(200, 192, string.format("%4d %4d %4d %4d", elevatorState[1], elevatorState[2], elevatorState[3], elevatorState[4]), V_SNAPTOLEFT, "thin")
	if (MM and HIDEO and MM.shwdwn)
		HIDEO.DrawTextPatch(v, 234, 4, duelSign, sortOfSine(leveltime, 9)+1, V_SNAPTOTOP|V_SNAPTORIGHT)
	end
end)
